/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.editor.refactor.RichText"]){dojo._hasResource["dojox.editor.refactor.RichText"]=true;dojo.provide("dojox.editor.refactor.RichText");dojo.require("dojo.AdapterRegistry");dojo.require("dijit._Widget");dojo.require("dijit._editor.selection");dojo.require("dijit._editor.range");dojo.require("dijit._editor.html");dojo.require("dojo.i18n");dojo.requireLocalization("dijit.form","Textarea",null,"ar,ca,cs,da,de,el,es,fi,fr,he,hu,it,ja,ko,nb,nl,pl,pt,pt-pt,ru,sk,sl,sv,ROOT,th,tr,zh,zh-tw");if(!dojo.config["useXDomain"]||dojo.config["allowXdRichTextSave"]){if(dojo._postLoad){(function(){var _1=dojo.doc.createElement("textarea");_1.id=dijit._scopeName+"._editor.RichText.savedContent";dojo.style(_1,{display:"none",position:"absolute",top:"-100px",left:"-100px",height:"3px",width:"3px"});dojo.body().appendChild(_1);})();}else{try{dojo.doc.write("<textarea id=\""+dijit._scopeName+"._editor.RichText.savedContent\" "+"style=\"display:none;position:absolute;top:-100px;left:-100px;height:3px;width:3px;overflow:hidden;\"></textarea>");}catch(e){}}}dojox.editor.refactor.RichTextIframeMixin={_writeOpen:function(_2){if(dojo.isIE||dojo.isSafari||dojo.isOpera){if(dojo.config["useXDomain"]&&!dojo.config["dojoBlankHtmlUrl"]){console.warn("dojox.editor.newRT.RichText: When using cross-domain Dojo builds,"+" please save dojo/resources/blank.html to your domain and set djConfig.dojoBlankHtmlUrl"+" to the path on your domain to blank.html");}var _3=dojo.config["dojoBlankHtmlUrl"]||(dojo.moduleUrl("dojo","resources/blank.html")+"");var _4=this.editorObject=this.iframe=dojo.doc.createElement("iframe");_4.id=this.id+"_iframe";_4.src=_3;_4.style.border="none";_4.style.width="100%";_4.frameBorder=0;this.editingArea.appendChild(_4);var h=null;var _6=dojo.hitch(this,function(){if(h){dojo.disconnect(h);h=null;}this.window=_4.contentWindow;var d=this.document=this.window.document;d.open();d.write(this._getIframeDocTxt(_2));d.close();if(dojo.isIE>=7){if(this.height){_4.style.height=this.height;}if(this.minHeight){_4.style.minHeight=this.minHeight;}}else{_4.style.height=this.height?this.height:this.minHeight;}if(dojo.isIE){this._localizeEditorCommands();}this.onLoad();this.savedContent=this.getValue(true);});if(dojo.isIE<7){var t=setInterval(function(){if(_4.contentWindow.isLoaded){clearInterval(t);_6();}},100);}else{h=dojo.connect(((dojo.isIE)?_4.contentWindow:_4),"onload",_6);}}else{this._drawIframe(_2);this.savedContent=this.getValue(true);}},_getIframeDocTxt:function(_9){var _a=dojo.getComputedStyle(this.domNode);if(!this.height&&!dojo.isMoz){_9="<div>"+_9+"</div>";}var _b=[_a.fontWeight,_a.fontSize,_a.fontFamily].join(" ");var _c=_a.lineHeight;if(_c.indexOf("px")>=0){_c=parseFloat(_c)/parseFloat(_a.fontSize);}else{if(_c.indexOf("em")>=0){_c=parseFloat(_c);}else{_c="1.0";}}return [this.isLeftToRight()?"<html><head>":"<html dir='rtl'><head>",(dojo.isMoz?"<title>"+this._localizedIframeTitles.iframeEditTitle+"</title>":""),"<style>","body,html {","\tbackground:transparent;","\tpadding: 0;","\tmargin: 0;","}","body{","\ttop:0px; left:0px; right:0px;",((this.height||dojo.isOpera)?"":"position: fixed;"),"\tfont:",_b,";","\tmin-height:",this.minHeight,";","\tline-height:",_c,"}","p{ margin: 1em 0 !important; }",(this.height?"":"body,html{overflow-y:hidden;/*for IE*/} body > div {overflow-x:auto;/*for FF to show vertical scrollbar*/}"),"li > ul:-moz-first-node, li > ol:-moz-first-node{ padding-top: 1.2em; } ","li{ min-height:1.2em; }","</style>",this._applyEditingAreaStyleSheets(),"</head><body>"+_9+"</body></html>"].join("");},_drawIframe:function(_d){if(!this.iframe){var _e=this.iframe=dojo.doc.createElement("iframe");_e.id=this.id+"_iframe";var _f=_e.style;_f.border="none";_f.lineHeight="0";_f.verticalAlign="bottom";this.editorObject=this.iframe;this._localizedIframeTitles=dojo.i18n.getLocalization("dijit.form","Textarea");var _10=dojo.query("label[for=\""+this.id+"\"]");if(_10.length){this._localizedIframeTitles.iframeEditTitle=_10[0].innerHTML+" "+this._localizedIframeTitles.iframeEditTitle;}}this.iframe.style.width=this.inheritWidth?this._oldWidth:"100%";if(this.height){this.iframe.style.height=this.height;}else{this.iframe.height=this._oldHeight;}var _11;if(this.textarea){_11=this.srcNodeRef;}else{_11=dojo.doc.createElement("div");_11.style.display="none";_11.innerHTML=_d;this.editingArea.appendChild(_11);}this.editingArea.appendChild(this.iframe);var _12=dojo.hitch(this,function(){if(!this.editNode){if(!this.document){try{if(this.iframe.contentWindow){this.window=this.iframe.contentWindow;this.document=this.iframe.contentWindow.document;}else{if(this.iframe.contentDocument){this.window=this.iframe.contentDocument.window;this.document=this.iframe.contentDocument;}}}catch(e){setTimeout(_12,50);return;}if(!this.document){setTimeout(_12,50);return;}var _13=this.document;_13.open();_13.write(this._getIframeDocTxt(_d));_13.close();dojo._destroyElement(_11);}if(!this.document.body){setTimeout(_12,50);return;}this.onLoad();}else{dojo._destroyElement(_11);this.editNode.innerHTML=_d;this.onDisplayChanged();}this._preDomFilterContent(this.editNode);});_12();},onLoad:function(e){this.focusNode=this.editNode=(this.height||dojo.isMoz)?this.document.body:this.document.body.firstChild;dojox.editor.refactor.RichText.prototype.onLoad.call(this,e);},_applyEditingAreaStyleSheets:function(){var _15=[];if(this.styleSheets){_15=this.styleSheets.split(";");this.styleSheets="";}_15=_15.concat(this.editingAreaStyleSheets);this.editingAreaStyleSheets=[];var _16="",i=0,url;while((url=_15[i++])){var _19=(new dojo._Url(dojo.global.location,url)).toString();this.editingAreaStyleSheets.push(_19);_16+="<link rel=\"stylesheet\" type=\"text/css\" href=\""+_19+"\">";}return _16;},addStyleSheet:function(uri){var url=uri.toString();if(url.charAt(0)=="."||(url.charAt(0)!="/"&&!uri.host)){url=(new dojo._Url(dojo.global.location,url)).toString();}if(dojo.indexOf(this.editingAreaStyleSheets,url)>-1){return;}this.editingAreaStyleSheets.push(url);if(this.document.createStyleSheet){this.document.createStyleSheet(url);}else{var _1c=this.document.getElementsByTagName("head")[0];var _1d=this.document.createElement("link");with(_1d){rel="stylesheet";type="text/css";href=url;}_1c.appendChild(_1d);}},removeStyleSheet:function(uri){var url=uri.toString();if(url.charAt(0)=="."||(url.charAt(0)!="/"&&!uri.host)){url=(new dojo._Url(dojo.global.location,url)).toString();}var _20=dojo.indexOf(this.editingAreaStyleSheets,url);if(_20==-1){return;}delete this.editingAreaStyleSheets[_20];dojo.withGlobal(this.window,"query",dojo,["link:[href=\""+url+"\"]"]).orphan();},_setDisabledAttr:function(_21){_21=Boolean(_21);if(dojo.isMoz&&this.iframe){this.document.designMode=_21?"off":"on";}dojox.editor.refactor.RichText.prototype._setDisabledAttr.call(this,_21);},blur:function(){this.window.blur();}};dojo.declare("dojox.editor.refactor.RichText",dijit._Widget,{constructor:function(_22){this.contentPreFilters=[];this.contentPostFilters=[];this.contentDomPreFilters=[];this.contentDomPostFilters=[];this.editingAreaStyleSheets=[];this._keyHandlers={};this.contentPreFilters.push(dojo.hitch(this,"_preFixUrlAttributes"));if(dojo.isMoz){this.contentPreFilters.push(this._fixContentForMoz);this.contentPostFilters.push(this._removeMozBogus);}if(dojo.isSafari){this.contentPostFilters.push(this._removeSafariBogus);}this.onLoadDeferred=new dojo.Deferred();this.useIframe=(dojo.isFF&&(dojo.isFF<3))||_22["useIframe"]||_22["styleSheets"];if(this.useIframe){dojo.mixin(this,dojox.editor.refactor.RichTextIframeMixin);}this.onLoadDeferred.addCallback(this,function(_23){this.connect(this.editNode,"onblur","_customOnBlur");this.connect(this.editNode,"onfocus","_customOnFocus");return _23;});},inheritWidth:false,focusOnLoad:false,name:"",styleSheets:"",useIframe:false,_content:"",height:"300px",minHeight:"1em",isClosed:true,isLoaded:false,_SEPARATOR:"@@**%%__RICHTEXTBOUNDRY__%%**@@",onLoadDeferred:null,isTabIndent:false,postCreate:function(){if("textarea"==this.domNode.tagName.toLowerCase()){console.warn("RichText should not be used with the TEXTAREA tag.  See dojox.editor.refactor.RichText docs.");}dojo.publish(dijit._scopeName+"._editor.RichText::init",[this]);this.open();this.setupDefaultShortcuts();},setupDefaultShortcuts:function(){var _24=dojo.hitch(this,function(cmd,arg){return function(){return !this.execCommand(cmd,arg);};});var _27={b:_24("bold"),i:_24("italic"),u:_24("underline"),a:_24("selectall"),s:function(){this.save(true);},m:function(){this.isTabIndent=!this.isTabIndent;},"1":_24("formatblock","h1"),"2":_24("formatblock","h2"),"3":_24("formatblock","h3"),"4":_24("formatblock","h4"),"\\":_24("insertunorderedlist")};if(!dojo.isIE){_27.Z=_24("redo");}for(var key in _27){this.addKeyHandler(key,true,false,_27[key]);}},events:["onKeyPress","onKeyDown","onKeyUp","onClick"],captureEvents:[],_editorCommandsLocalized:false,_localizeEditorCommands:function(){if(this._editorCommandsLocalized){return;}this._editorCommandsLocalized=true;var _29=["div","p","pre","h1","h2","h3","h4","h5","h6","ol","ul","address"];var _2a="",_2b,i=0;while((_2b=_29[i++])){if(_2b.charAt(1)!="l"){_2a+="<"+_2b+"><span>content</span></"+_2b+"><br/>";}else{_2a+="<"+_2b+"><li>content</li></"+_2b+"><br/>";}}var div=dojo.doc.createElement("div");dojo.style(div,{position:"absolute",left:"-2000px",top:"-2000px"});dojo.doc.body.appendChild(div);div.innerHTML=_2a;var _2e=div.firstChild;try{while(_2e){dijit._editor.selection.selectElement(_2e.firstChild);this.s_call("selectElement",[_2e.firstChild]);var _2f=_2e.tagName.toLowerCase();this._local2NativeFormatNames[_2f]=document.queryCommandValue("formatblock");this._native2LocalFormatNames[this._local2NativeFormatNames[_2f]]=_2f;_2e=_2e.nextSibling.nextSibling;}}catch(e){}dojo.body().removeChild(div);},open:function(_30){if((!this.onLoadDeferred)||(this.onLoadDeferred.fired>=0)){this.onLoadDeferred=new dojo.Deferred();}if(!this.isClosed){this.close();}dojo.publish(dijit._scopeName+"._editor.RichText::open",[this]);this._content="";if((arguments.length==1)&&(_30["nodeName"])){this.domNode=_30;}var dn=this.domNode;var _32;if((dn["nodeName"])&&(dn.nodeName.toLowerCase()=="textarea")){var ta=this.textarea=dn;this.name=ta.name;_32=this._preFilterContent(ta.value);dn=this.domNode=dojo.doc.createElement("div");dn.setAttribute("widgetId",this.id);ta.removeAttribute("widgetId");dn.cssText=ta.cssText;dn.className+=" "+ta.className;dojo.place(dn,ta,"before");ta.onfocus=function(e){dojo.stopEvent(e);return false;};var _35=dojo.hitch(this,function(){with(ta.style){display="block";position="absolute";left=top="-1000px";if(dojo.isIE){this.__overflow=overflow;overflow="hidden";}}});if(dojo.isIE){setTimeout(_35,10);}else{_35();}if(ta.form){dojo.connect(ta.form,"onsubmit",this,function(){ta.value=this.getValue();});}}else{_32=this._preFilterContent(dijit._editor.getChildrenHtml(dn));dn.innerHTML="";}if(_32==""){_32="&nbsp;";}var _36=dojo.contentBox(dn);this._oldHeight=_36.h;this._oldWidth=_36.w;this.savedContent=_32;if((dn["nodeName"])&&(dn.nodeName=="LI")){dn.innerHTML=" <br>";}this.editingArea=dn.ownerDocument.createElement("div");dn.appendChild(this.editingArea);if(this.name!=""&&(!dojo.config["useXDomain"]||dojo.config["allowXdRichTextSave"])){var _37=dojo.byId(dijit._scopeName+"._editor.RichText.savedContent");if(_37.value!=""){var _38=_37.value.split(this._SEPARATOR),i=0,dat;while((dat=_38[i++])){var _3b=dat.split(":");if(_3b[0]==this.name){_32=_3b[1];_38.splice(i,1);break;}}}this.connect(window,"onbeforeunload","_saveContent");}this.isClosed=false;this._writeOpen(_32);if(dn.nodeName=="LI"){dn.lastChild.style.marginTop="-1.2em";}dojo.addClass(dn,"RichTextEditable");return this.onLoadDeferred;},_writeOpen:function(_3c){var en=this.focusNode=this.editNode=this.editingArea;en.id=this.id;en.className="dijitEditorArea";en.innerHTML=_3c;en.contentEditable=true;if(this.height){en.style.height=this.height;}if(this.height){en.style.overflowY="auto";}this.window=dojo.global;this.document=dojo.doc;if(dojo.isIE){this._localizeEditorCommands();}this.onLoad();},_local2NativeFormatNames:{},_native2LocalFormatNames:{},_localizedIframeTitles:null,disabled:true,_mozSettingProps:{"styleWithCSS":false},_setDisabledAttr:function(_3e){_3e=Boolean(_3e);if(!this.editNode){return;}this.editNode.contentEditable=!_3e;this.disabled=_3e;if(!_3e&&this._mozSettingProps){var ps=this._mozSettingProps;for(var n in ps){if(ps.hasOwnProperty(n)){try{this.document.execCommand(n,false,ps[n]);}catch(e){}}}}},setDisabled:function(_41){dojo.deprecated("dijit.Editor::setDisabled is deprecated","use dijit.Editor::attr(\"disabled\",boolean) instead",2);this.attr("disabled",_41);},_isResized:function(){return false;},onLoad:function(e){this.isLoaded=true;if(!this.window.__registeredWindow){this.window.__registeredWindow=true;dijit.registerWin(this.window);}try{this.attr("disabled",true);this.attr("disabled",false);}catch(e){var _43=dojo.connect(this,"onClick",this,function(){this.attr("disabled",false);dojo.disconnect(_43);});}this._preDomFilterContent(this.editNode);var _44=this.events.concat(this.captureEvents);var ap=(this.iframe)?this.document:this.editNode;dojo.forEach(_44,function(_46){this.connect(ap,_46.toLowerCase(),_46);},this);if(dojo.isIE){this.editNode.style.zoom=1;}if(this.focusOnLoad){setTimeout(dojo.hitch(this,"focus"),0);}this.onDisplayChanged(e);if(this.onLoadDeferred){this.onLoadDeferred.callback(true);}},onKeyDown:function(e){if(dojo.isIE){if(e.keyCode===dojo.keys.BACKSPACE&&this.document.selection.type==="Control"){dojo.stopEvent(e);this.execCommand("delete");}}return true;},_lastPressStopped:false,onKeyUp:function(e){if(this._lastPressStopped){this._lastPressStopped=false;dojo.stopEvent(e);return false;}return true;},onKeyPress:function(e){var c=e.keyChar.toLowerCase()||e.keyCode;var _4b=this._keyHandlers[c];var _4c=arguments;if(_4b){dojo.forEach(_4b,function(h){if((!!h.shift==!!e.shiftKey)&&(!!h.ctrl==!!e.ctrlKey)){if(!h.handler.apply(this,_4c)){dojo.stopEvent(e);this._lastPressStopped=true;}}},this);}if(!this._onKeyHitch){this._onKeyHitch=dojo.hitch(this,"onKeyPressed");}setTimeout(this._onKeyHitch,1);return true;},addKeyHandler:function(key,_4f,_50,_51){if(!dojo.isArray(this._keyHandlers[key])){this._keyHandlers[key]=[];}this._keyHandlers[key].push({shift:_50||false,ctrl:_4f||false,handler:_51});},onKeyPressed:function(){this.onDisplayChanged();},onClick:function(e){this.onDisplayChanged(e);},_onMouseDown:function(e){if(!this._focused&&!this.disabled){this.focus();}},_savedSelection:null,_saveSelection:function(){var r=dijit.range.getSelection(this.window).getRangeAt(0);var _55=this._getRangeNodes(r);this._savedSelection={range:((dojo.isIE)?r.duplicate():r.cloneRange()),nodes:_55,bookmark:this._getBookmark(_55)};},_onBlur:function(e){},_customOnBlur:function(e){this._saveSelection();var _c=this.getValue(true);if(_c!=this.savedContent){this.onChange(_c);this.savedContent=_c;}if(dojo.isMoz&&this.iframe){this.iframe.contentDocument.title=this._localizedIframeTitles.iframeEditTitle;}e.stopPropagation();},_initialFocus:true,_customOnFocus:function(e){setTimeout(dojo.hitch(this,"_doOnFocus"),10);},_doOnFocus:function(){if(this._initialFocus){this._initialFocus=false;if(dojo.isMoz){if(this.editNode.innerHTML.replace(/^\s+|\s+$/g,"")=="&nbsp;"){this.placeCursorAtStart();}}}if(dojo.isSafari){this.placeCursorAtStart();}if(this._savedSelection){this._moveToBookmark(this._savedSelection.bookmark);}this._savedSelection=null;},blur:function(){this.editNode.blur();},focus:function(){if(!this.iframe&&dojo.isSafari){return;}if(this.iframe&&!dojo.isIE){dijit.focus(this.iframe);}else{if(this.editNode&&this.editNode.focus){this.editNode.focus();}}},updateInterval:200,_updateTimer:null,onDisplayChanged:function(e){if(this._updateTimer){clearTimeout(this._updateTimer);}if(!this._updateHandler){this._updateHandler=dojo.hitch(this,"onNormalizedDisplayChanged");}this._updateTimer=setTimeout(this._updateHandler,this.updateInterval);},onNormalizedDisplayChanged:function(){delete this._updateTimer;},onChange:function(_5b){},_normalizeCommand:function(cmd){var _5d=cmd.toLowerCase();if(_5d=="formatblock"){if(dojo.isSafari){_5d="heading";}}else{if(_5d=="hilitecolor"&&!dojo.isMoz){_5d="backcolor";}}return _5d;},_qcaCache:{},queryCommandAvailable:function(_5e){var ca=this._qcaCache[_5e];if(ca!=undefined){return ca;}return this._qcaCache[_5e]=this._queryCommandAvailable(_5e);},_queryCommandAvailable:function(_60){var ie=1;var _62=1<<1;var _63=1<<2;var _64=1<<3;var _65=1<<4;var _66=dojo.isSafari;function isSupportedBy(_67){return {ie:Boolean(_67&ie),mozilla:Boolean(_67&_62),safari:Boolean(_67&_63),safari420:Boolean(_67&_65),opera:Boolean(_67&_64)};};var _68=null;switch(_60.toLowerCase()){case "bold":case "italic":case "underline":case "subscript":case "superscript":case "fontname":case "fontsize":case "forecolor":case "hilitecolor":case "justifycenter":case "justifyfull":case "justifyleft":case "justifyright":case "delete":case "selectall":case "toggledir":_68=isSupportedBy(_62|ie|_63|_64);break;case "createlink":case "unlink":case "removeformat":case "inserthorizontalrule":case "insertimage":case "insertorderedlist":case "insertunorderedlist":case "indent":case "outdent":case "formatblock":case "inserthtml":case "undo":case "redo":case "strikethrough":case "tabindent":_68=isSupportedBy(_62|ie|_64|_65);break;case "blockdirltr":case "blockdirrtl":case "dirltr":case "dirrtl":case "inlinedirltr":case "inlinedirrtl":_68=isSupportedBy(ie);break;case "cut":case "copy":case "paste":_68=isSupportedBy(ie|_62|_65);break;case "inserttable":_68=isSupportedBy(_62|ie);break;case "insertcell":case "insertcol":case "insertrow":case "deletecells":case "deletecols":case "deleterows":case "mergecells":case "splitcell":_68=isSupportedBy(ie|_62);break;default:return false;}return (dojo.isIE&&_68.ie)||(dojo.isMoz&&_68.mozilla)||(dojo.isSafari&&_68.safari)||(_66&&_68.safari420)||(dojo.isOpera&&_68.opera);},execCommand:function(_69,_6a){var _6b;this.focus();var c=dojox.editor.refactor.RichText._commands;var _6d;if(_6d=c.match(_69.toLowerCase())){this.editNode.normalize();var _6e=this.window.getSelection();try{if(_6e.rangeCount){var r=_6e.getRangeAt(0);}}catch(e){}return _6d.applyCommand(this,_6a);}_69=this._normalizeCommand(_69);if(_6a!=undefined){if(_69=="heading"){throw new Error("unimplemented");}else{if((_69=="formatblock")&&dojo.isIE){_6a="<"+_6a+">";}}}if(_69=="inserthtml"){_6a=this._preFilterContent(_6a);_6b=true;if(dojo.isIE){var _70=this.document.selection.createRange();_70.pasteHTML(_6a);_70.select();}else{if(dojo.isMoz&&!_6a.length){this._sCall("remove");_6b=true;}else{_6b=this.document.execCommand(_69,false,_6a);}}}else{if((_69=="unlink")&&(this.queryCommandEnabled("unlink"))&&(dojo.isMoz||dojo.isSafari)){var a=this._sCall("getAncestorElement",["a"]);this._sCall("selectElement",[a]);_6b=this.document.execCommand("unlink",false,null);}else{if((_69=="hilitecolor")&&(dojo.isMoz)){this.document.execCommand("styleWithCSS",false,true);_6b=this.document.execCommand(_69,false,_6a);this.document.execCommand("styleWithCSS",false,false);}else{if((dojo.isIE)&&((_69=="backcolor")||(_69=="forecolor"))){_6a=arguments.length>1?_6a:null;_6b=this.document.execCommand(_69,false,_6a);}else{_6a=arguments.length>1?_6a:null;if(_6a||_69!="createlink"){_6b=this.document.execCommand(_69,false,_6a);}}}}}this.onDisplayChanged();return _6b;},queryCommandEnabled:function(_72){if(this.disabled){return false;}_72=this._normalizeCommand(_72);if(dojo.isMoz||dojo.isSafari){if(_72=="unlink"){this._sCall("hasAncestorElement",["a"]);}else{if(_72=="inserttable"){return true;}}}if(dojo.isSafari){if(_72=="copy"){_72="cut";}else{if(_72=="paste"){return true;}}}if(_72=="indent"){var li=this._sCall("getAncestorElement",["li"]);var n=li&&li.previousSibling;while(n){if(n.nodeType==1){return true;}n=n.previousSibling;}return false;}else{if(_72=="outdent"){return this._sCall("hasAncestorElement",["li"]);}}var _75=dojo.isIE?this.document.selection.createRange():this.document;return _75.queryCommandEnabled(_72);},queryCommandState:function(_76){if(this.disabled){return false;}var c=dojox.editor.refactor.RichText._commands;var _78;if(_78=c.match(_76)){return _78.queryState(this);}_76=this._normalizeCommand(_76);this.editNode.contentEditable=true;return this.document.queryCommandState(_76);},queryCommandValue:function(_79){if(this.disabled){return false;}var r;_79=this._normalizeCommand(_79);if(dojo.isIE&&_79=="formatblock"){r=this._native2LocalFormatNames[this.document.queryCommandValue(_79)];}else{r=this.document.queryCommandValue(_79);}return r;},_sCall:function(_7b,_7c){dojo.withGlobal(this.window,_7b,dijit._editor.selection,_7c);},placeCursorAtStart:function(){this.focus();var _7d=false;if(dojo.isMoz){var _7e=this.editNode.firstChild;while(_7e){if(_7e.nodeType==3){if(_7e.nodeValue.replace(/^\s+|\s+$/g,"").length>0){_7d=true;this._sCall("selectElement",[_7e]);break;}}else{if(_7e.nodeType==1){_7d=true;this._sCall("selectElementChildren",[_7e]);break;}}_7e=_7e.nextSibling;}}else{_7d=true;this._sCall("selectElementChildren",[this.editNode]);}if(_7d){this._sCall("collapse",[true]);}},placeCursorAtEnd:function(){this.focus();var _7f=false;if(dojo.isMoz){var _80=this.editNode.lastChild;while(_80){if(_80.nodeType==3){if(_80.nodeValue.replace(/^\s+|\s+$/g,"").length>0){_7f=true;this._sCall("selectElement",[_80]);break;}}else{if(_80.nodeType==1){_7f=true;if(_80.lastChild){this._sCall("selectElement",[_80.lastChild]);}else{this._sCall("selectElement",[_80]);}break;}}_80=_80.previousSibling;}}else{_7f=true;this._sCall("selectElementChildren",[this.editNode]);}if(_7f){this._sCall("collapse",[false]);}},getValue:function(_81){if(this.textarea){if(this.isClosed||!this.isLoaded){return this.textarea.value;}}return this._postFilterContent(null,_81);},setValue:function(_82){if(this.textarea&&(this.isClosed||!this.isLoaded)){this.textarea.value=_82;}else{_82=this._preFilterContent(_82);var _83=this.isClosed?this.domNode:this.editNode;_83.innerHTML=_82;this._preDomFilterContent(_83);}this.onDisplayChanged();},replaceValue:function(_84){if(this.isClosed){this.setValue(_84);}else{if(this.window&&this.window.getSelection&&!dojo.isMoz){this.setValue(_84);}else{if(this.window&&this.window.getSelection){_84=this._preFilterContent(_84);this.execCommand("selectall");if(dojo.isMoz&&!_84){_84="&nbsp;";}this.execCommand("inserthtml",_84);this._preDomFilterContent(this.editNode);}else{if(this.document&&this.document.selection){this.setValue(_84);}}}}},_preFilterContent:function(_85){var ec=_85;dojo.forEach(this.contentPreFilters,function(ef){if(ef){ec=ef(ec);}});return ec;},_preDomFilterContent:function(dom){dom=dom||this.editNode;dojo.forEach(this.contentDomPreFilters,function(ef){if(ef&&dojo.isFunction(ef)){ef(dom);}},this);},_postFilterContent:function(dom,_8b){var ec;if(!dojo.isString(dom)){dom=dom||this.editNode;if(this.contentDomPostFilters.length){if(_8b){dom=dojo.clone(dom);}dojo.forEach(this.contentDomPostFilters,function(ef){dom=ef(dom);});}ec=dijit._editor.getChildrenHtml(dom);}else{ec=dom;}if(!dojo.trim(ec.replace(/^\xA0\xA0*/,"").replace(/\xA0\xA0*$/,"")).length){ec="";}dojo.forEach(this.contentPostFilters,function(ef){ec=ef(ec);});return ec;},_saveContent:function(e){var _90=dojo.byId(dijit._scopeName+"._editor.RichText.savedContent");_90.value+=this._SEPARATOR+this.name+":"+this.getValue();},escapeXml:function(str,_92){str=str.replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;");if(!_92){str=str.replace(/'/gm,"&#39;");}return str;},getNodeHtml:function(_93){dojo.deprecated("dijit.Editor::getNodeHtml is deprecated","use dijit._editor.getNodeHtml instead",2);return dijit._editor.getNodeHtml(_93);},getNodeChildrenHtml:function(dom){dojo.deprecated("dijit.Editor::getNodeChildrenHtml is deprecated","use dijit._editor.getChildrenHtml instead",2);return dijit._editor.getChildrenHtml(dom);},close:function(_95,_96){if(this.isClosed){return false;}if(!arguments.length){_95=true;}this._content=this.getValue();var _97=(this.savedContent!=this._content);if(this.interval){clearInterval(this.interval);}if(this.textarea){with(this.textarea.style){position="";left=top="";if(dojo.isIE){overflow=this.__overflow;this.__overflow=null;}}this.textarea.value=_95?this._content:this.savedContent;dojo._destroyElement(this.domNode);this.domNode=this.textarea;}else{this.domNode.innerHTML=_95?this._content:this.savedContent;}dojo.removeClass(this.domNode,"RichTextEditable");this.isClosed=true;this.isLoaded=false;delete this.editNode;if(this.window&&this.window._frameElement){this.window._frameElement=null;}this.window=null;this.document=null;this.editingArea=null;this.editorObject=null;return _97;},destroyRendering:function(){},destroy:function(){this.destroyRendering();if(!this.isClosed){this.close(false);}this.inherited("destroy",arguments);},_removeMozBogus:function(_98){return _98.replace(/\stype="_moz"/gi,"").replace(/\s_moz_dirty=""/gi,"");},_removeSafariBogus:function(_99){return _99.replace(/\sclass="webkit-block-placeholder"/gi,"");},_fixContentForMoz:function(_9a){return _9a.replace(/<(\/)?strong([ \>])/gi,"<$1b$2").replace(/<(\/)?em([ \>])/gi,"<$1i$2");},_preFixUrlAttributes:function(_9b){return _9b.replace(/(?:(<a(?=\s).*?\shref=)("|')(.*?)\2)|(?:(<a\s.*?href=)([^"'][^ >]+))/gi,"$1$4$2$3$5$2 _djrealurl=$2$3$5$2").replace(/(?:(<img(?=\s).*?\ssrc=)("|')(.*?)\2)|(?:(<img\s.*?src=)([^"'][^ >]+))/gi,"$1$4$2$3$5$2 _djrealurl=$2$3$5$2");},_bookmarkId:0,_getBookmark:function(_9c){var _9d,_9e;var id=this._bookmarkId++;if(_9c.length){_9d=this.document.createElement("span");dojo.attr(_9d,{isBookmark:"true",bookmarkId:id,style:{width:"1px",height:"1px",overflow:"hidden",border:"3px solid blue"}});_9e=_9d.cloneNode(false);var sid="_richText_startMarker_"+this.id+"_"+id;var eid="_richText_endMarker_"+this.id+"_"+id;_9d.id=sid;_9e.id=eid;if(dojo.isIE){_9d.innerHTML=sid;_9e.innerHTML=eid;}dojo.place(_9d,_9c[0],"before");dojo.place(_9e,_9c.last(),"after");}return [_9d,_9e];},_getRangeNodes:function(s){var r=[];r.last=function(){return this[this.length-1];};var _a4=s.commonAncestorContainer;var sc=s.startContainer;var so=s.startOffset;var ec=s.endContainer;var eo=s.endOffset;var od=sc.ownerDocument;var tmp=od.createTextNode("");if(sc===ec){var _ab=(dojo.isIE)?!s.text.length:s.collapsed;if(_ab){var _ac=tmp.cloneNode(true);if(sc.nodeType==1){dojo.place(_ac,this.domNode,"first");}else{var _ad=sc.splitText(so);sc.parentNode.insertBefore(_ac,_ad);}r.push(_ac);}else{if(1==sc.nodeType){var tmp=so;do{r.push(sc.childNodes.item(tmp));tmp++;}while(tmp<eo);}else{if(3==sc.nodeType){sc.splitText(eo);r.push(sc.splitText(so));}}}return r;}if(3==sc.nodeType){var l=String(sc.value).length;if(0==so){if(sc.parentNode!=_a4&&!sc.previousSibling){r.push(sc.parentNode);}else{r.push(sc);}}else{if(l==so){var ns=sc.nextSibling;if(ns){if(!dojo.isDescendant(ec,ns)){r.push(ns);}else{var _ac=tmp.cloneNode();dojo.place(_ac,sc,"after");r.push(_ac);}}}else{r.push(sc.splitText(so));ec.splitText(eo);}}}else{if(1==sc.nodeType){var cn=sc.childNodes;if(sc===_a4){var end=false;dojo.forEach(cn,function(_b2,idx,arr){if(end){return;}if((_b2===ec)||dojo.isDescendant(ec,_b2)){end=true;return;}if(idx>=so){r.push(_b2);}});}else{if(sc.parentNode===_a4){dojo.forEach(cn,function(_b5,idx,arr){if(idx>=so){r.push(_b5);}});var _ad=sc.nextSibling;while(_ad&&((_ad!==ec)&&!dojo.isDescendant(ec,_ad))){r.push(_ad);_ad=_ad.nextSibling;}}else{r.push(sc);}}}}this._collectNodes(r,_a4,ec,eo);return r;},_collectNodes:function(arr,_b9,end,_bb){var _bc=arr.last();if(!_bc||(_bc===_b9)){return;}do{var n=_bc.nextSibling;while(n){if(dojo.isDescendant(end,n)){break;}arr.push(n);n=n.nextSibling;}_bc=_bc.parentNode;}while(_bc&&_bc!=_b9);_bc=arr.last();if(1==end.nodeType){end=end.childNodes[_bb-1];}arr.push(end);var al=arr.length-1;var _bf=end;do{var n=_bf.previousSibling;while(n){if(n==_bc){return;}arr.splice(al,0,n);n=n.previousSibling;}_bf=_bf.parentNode;}while(_bf&&_bf!=_b9);},_moveToBookmark:function(_c0){var _c1=_c0[0];var end=_c0[1];if(!_c1||!end){console.error("_moveToBookmark must be passed start/end caps to be removed!");return;}if(dojo.isIE){var r=this.document.createTextRange();var r2=r.duplicate();var _c5=r.findText(_c1.innerHTML,100000000);var _c6=r2.findText(end.innerHTML,100000000);var r3=r.duplicate();r3.move("character",_c1.innerHTML.length);r3.setEndPoint("EndToStart",r2);r3.select();}var _c8=_c1.nextSibling;var _c9=end.previousSibling;var _ca=end.nextSibling;if(dojo.isIE){end.innerHTML=_c1.innerHTML="";}_c1.parentNode.removeChild(_c1);end.parentNode.removeChild(end);if(!dojo.isIE){var s=this.window.getSelection();if(s.rangeCount>0){s.removeAllRanges();}var r=this.document.createRange();r.setStartBefore(_c8);var ep=_c9||_ca.previousSibling||_ca.parentNode.previousSibling||_ca;r.setEndAfter(ep);s.addRange(r);}}});dojo.declare("dojox.editor.refactor.Command",null,{name:"",constructor:function(_cd){dojo.mixin(this,_cd);this.register();this.init();},register:function(_ce){var r=this.registry=_ce||this.registry;if(r&&this.name.length){r.register(this.name,dojo.hitch(this,"registryCheck"),this);}},init:function(){},registryCheck:function(_d0,_d1){return (_d0==this.name);},queryEnabled:function(rt){return false;},queryValue:function(rt){return null;},queryState:function(rt){return false;},applyCommand:function(rt,_d6){return true;}});dojo.declare("dojox.editor.refactor.TagWrapCommand",dojox.editor.refactor.Command,{init:function(){if(this.tag){this._upperTag=this._upperTag||this.tag.toUpperCase();}if(this.name){this._nameAttr=this.name+"_command";}},tag:"",attrs:{},applicationHelper:function(arg,_d8){},removalHelper:function(arg,_da){},isntAppliedHelper:function(_db){return false;},reParentOnRemoval:false,applyCommand:function(rt,arg){var _de=dijit.range.getSelection(rt.window);var r=_de.getRangeAt(0);var _e0=rt._getRangeNodes(r);var _e1=rt._getBookmark(_e0);var _e2=dojo.filter(_e0,this._isntAppliedToNode,this);if(!_e2.length){dojo.forEach(_e0,this._removeFromNode,this);dojo.forEach(_e0,dojo.hitch(this,"removalHelper",arg));}else{dojo.forEach(_e2,this._applyToNode,this);dojo.forEach(_e2,dojo.hitch(this,"applicationHelper",arg));}rt._moveToBookmark(_e1);return true;},queryState:function(rt){var _e4=dijit.range.getSelection(rt.window);var r=_e4.getRangeAt(0);return this._isApplied(rt._getRangeNodes(r));},_isApplied:function(rn){var a=(0==dojo.filter(rn,this._isntAppliedToNode,this));return a;},_isntAppliedToNode:function(_e8){var ta=this.attrs;var nt=_e8.nodeType;if(1==nt){if(this.tag.length){if(!this._isTagMatch(_e8)){return true;}}for(var x in ta){if(x=="style"){continue;}if(dojo.attr(_e8,x)!=ta[x]){return true;}}if(ta.style){for(var x in ta.style){if(dojo.style(_e8,x)!=ta.style[x]){return true;}}}return this.isntAppliedHelper(_e8);}else{if(3==nt){if(!_e8.nodeValue.length){return false;}return this._isntAppliedToNode(_e8.parentNode);}}},_isTagMatch:function(_ec){return (_ec.tagName==this._upperTag);},_applyToNode:function(_ed){var nt=_ed.nodeType;var el=_ed;if((3==nt)||!this._isTagMatch(_ed)){el=_ed.ownerDocument.createElement(this.tag||"span");_ed.parentNode.replaceChild(el,_ed);el.appendChild(_ed);}dojo.attr(el,this.attrs);dojo.attr(el,this._nameAttr,"applied");return el;},_singleRemoveFromNode:function(_f0){try{dojo.removeAttr(_f0,this._nameAttr);}catch(e){}for(var x in this.attrs){if(x!="style"){dojo.attr(_f0,x,"");}}for(var x in this.attrs.style){dojo.style(_f0,x,"");}if(this.reParentOnRemoval){while(_f0.firstChild){_f0.parentNode.insertBefore(_f0.firstChild,_f0);}_f0.parentNode.removeChild(_f0);}},_removeFromNode:function(_f2,idx,arr){if(3==_f2.nodeType){var pn=_f2.parentNode;if(pn.lastChild==_f2){dojo.place(_f2,pn,"after");}else{if(pn.firstChild==_f2){dojo.place(_f2,pn,"before");}else{return this._removeFromNode(pn,idx,arr);}}return;}if(dojo.attr(_f2,this._nameAttr)){this._singleRemoveFromNode(_f2);}dojo.query("["+this._nameAttr+"]",_f2).forEach(this._singleRemoveFromNode,this);}});(function(){var de=dojox.editor.refactor;var c=de.RichText._commands=new dojo.AdapterRegistry(true);new de.TagWrapCommand({name:"bold",tag:"span",attrs:{style:{fontWeight:"bold"}},registry:c});new de.TagWrapCommand({name:"italic",tag:"span",attrs:{style:{fontStyle:"italic"}},registry:c});new de.TagWrapCommand({name:"strikethrough",tag:"span",attrs:{style:{textDecoration:"line-through"}},registry:c});new de.TagWrapCommand({name:"underline",tag:"span",attrs:{style:{textDecoration:"underline"}},registry:c});new de.TagWrapCommand({name:"subscript",tag:"span",attrs:{style:{verticalAlign:"sub"}},registry:c});new de.TagWrapCommand({name:"superscript",tag:"span",attrs:{style:{verticalAlign:"super"}},registry:c});new de.TagWrapCommand({name:"fontname",tag:"span",applicationHelper:function(arg,_f9){dojo.style(_f9,"fontFamily",arg);},removalHelper:function(arg,_fb){dojo.style(_fb,"fontFamily","");},isntAppliedHelper:function(_fc){return !dojo.style(_fc,"fontFamily");},registry:c});})();}