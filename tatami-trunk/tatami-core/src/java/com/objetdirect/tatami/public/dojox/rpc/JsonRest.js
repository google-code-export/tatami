/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.rpc.JsonRest"]){dojo._hasResource["dojox.rpc.JsonRest"]=true;dojo.provide("dojox.rpc.JsonRest");dojo.require("dojox.json.ref");dojo.require("dojox.rpc.Rest");(function(){var _1=[];var _2=dojox.rpc.Rest;var _3=/(.*?)(#?(\.\w+)|(\[.+))+$/;var jr=dojox.rpc.JsonRest={commit:function(_5){var _6;_5=_5||{};var _7=[];var _8={};var _9=[];for(var i=0;i<_1.length;i++){var _b=_1[i];var _c=_b.object;var _d=_b.old;var _e=false;if(!(_5.service&&(_c||_d)&&(_c||_d).__id.indexOf(_5.service.servicePath))&&_b.save){if(_c){if(_d){while(_c.__id.match(_3)){var _f=_c.__id.match(_3)[1];_c=_2._index[_f];}if(!(_c.__id in _8)){_8[_c.__id]=_c;_7.push({method:"put",target:_c,content:_c});}}else{_7.push({method:"post",target:{__id:jr.getServiceAndId(_c.__id).service.servicePath},content:_c});}}else{if(_d){_7.push({method:"delete",target:_d});}}_9.push(_b);_1.splice(i--,1);}}var _10;var _11=dojo.xhr;_6=_7.length;var _12;dojo.xhr=function(_13,_14){_14.headers=_14.headers||{};_14.headers["X-Transaction"]=_7.length-1==i?"commit":"open";if(_12){_14.headers["Content-Location"]=_12;}return _11.apply(dojo,arguments);};for(i=0;i<_7.length;i++){var _15=_7[i];dojox.rpc.JsonRest._contentId=_15.content&&_15.content.__id;var _16=_15.method=="post";_12=_16&&dojox.rpc.JsonRest._contentId;var _17=jr.getServiceAndId(_15.target.__id);var _18=_17.service;var dfd=_15.deferred=_18[_15.method](_17.id.replace(/#/,""),dojox.json.ref.toJson(_15.content,false,_18.servicePath,true));(function(_1a,dfd,_1c){dfd.addCallback(function(_1d){try{var _1e=dfd.ioArgs.xhr.getResponseHeader("Location");if(_1e){var _1f=_1e.match(/(^\w+:\/\/)/)&&_1e.indexOf(_1c.servicePath);_1e=_1f>0?_1e.substring(_1f):(_1c.servicePath+_1e).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3");_1a.__id=_1e;_2._index[_1e]=_1a;}_1d=_1d&&dojox.json.ref.resolveJson(_1d,{index:_2._index,idPrefix:_1c.servicePath,idAttribute:jr.getIdAttribute(_1c),schemas:jr.schemas,loader:jr._loader,assignAbsoluteIds:true});}catch(e){}if(!(--_6)){if(_5.onComplete){_5.onComplete.call(_5.scope);}}return _1d;});})(_16&&_15.content,dfd,_18);dfd.addErrback(function(_20){_6=-1;var _21=_1;dirtyObject=_9;numDirty=0;jr.revert();_1=_21;if(_5.onError){_5.onError();}return _20;});}dojo.xhr=_11;return _7;},getDirtyObjects:function(){return _1;},revert:function(_22){for(var i=_1.length;i>0;){i--;var _24=_1[i];var _25=_24.object;var old=_24.old;if(!(_22&&(_25||old)&&(_25||old).__id.indexOf(kwArgs.service.servicePath))){if(_25&&old){for(var j in old){if(old.hasOwnProperty(j)){_25[j]=old[j];}}for(j in _25){if(!old.hasOwnProperty(j)){delete _25[j];}}}_1.splice(i,1);}}},changing:function(_28,_29){if(!_28.__id){return;}for(var i=0;i<_1.length;i++){var _2b=_1[i];if(_28==_2b.object){if(_29){_2b.object=false;if(!this._saveNotNeeded){_2b.save=true;}}return;}}var old=_28 instanceof Array?[]:{};for(i in _28){if(_28.hasOwnProperty(i)){old[i]=_28[i];}}_1.push({object:!_29&&_28,old:old,save:!this._saveNotNeeded});},deleteObject:function(_2d){this.changing(_2d,true);},getConstructor:function(_2e,_2f){if(typeof _2e=="string"){var _30=_2e;_2e=new dojox.rpc.Rest(_2e,true);this.registerService(_2e,_30,_2f);}if(_2e._constructor){return _2e._constructor;}_2e._constructor=function(_31){if(_31){dojo.mixin(this,_31);}var _32=jr.getIdAttribute(_2e);_2._index[this.__id=this.__clientId=_2e.servicePath+(this[_32]||(this[_32]=Math.random().toString(16).substring(2,14)+Math.random().toString(16).substring(2,14)))]=this;_1.push({object:this,save:true});};return dojo.mixin(_2e._constructor,_2e._schema,{load:_2e});},fetch:function(_33){var _34=jr.getServiceAndId(_33);return this.byId(_34.service,_34.id);},getIdAttribute:function(_35){var _36=_35._schema;var _37;if(_36){if(!(_37=_36._idAttr)){for(var i in _36.properties){if(_36.properties[i].identity){_36._idAttr=_37=i;}}}}return _37||"id";},getServiceAndId:function(_39){var _3a=_39.match(/^(.*\/)([^\/]*)$/);var svc=jr.services[_3a[1]]||new dojox.rpc.Rest(_3a[1],true);return {service:svc,id:_3a[2]};},services:{},schemas:{},registerService:function(_3c,_3d,_3e){_3d=_3d||_3c.servicePath;_3d=_3c.servicePath=_3d.match(/\/$/)?_3d:(_3d+"/");_3c._schema=jr.schemas[_3d]=_3e||_3c._schema||{};jr.services[_3d]=_3c;},byId:function(_3f,id){var _41,_42=_2._index[(_3f.servicePath||"")+id];if(_42&&!_42._loadObject){_41=new dojo.Deferred();_41.callback(_42);return _41;}return this.query(_3f,id);},query:function(_43,id,_45){var _46=_43(id,_45);_46.addCallback(function(_47){if(_47.nodeType&&_47.cloneNode){return _47;}return dojox.json.ref.resolveJson(_47,{defaultId:typeof id!="string"||(_45&&(_45.start||_45.count))?undefined:id,index:_2._index,idPrefix:_43.servicePath,idAttribute:jr.getIdAttribute(_43),schemas:jr.schemas,loader:jr._loader,assignAbsoluteIds:true});});return _46;},_loader:function(_48){var _49=jr.getServiceAndId(this.__id);var _4a=this;jr.query(_49.service,_49.id).addBoth(function(_4b){if(_4b==_4a){delete _4b.$ref;delete _4b._loadObject;}else{_4a._loadObject=function(_4c){_4c(_4b);};}_48(_4b);});},isDirty:function(_4d){for(var i=0,l=_1.length;i<l;i++){if(_1[i].object==_4d){return true;}}return false;}};})();}