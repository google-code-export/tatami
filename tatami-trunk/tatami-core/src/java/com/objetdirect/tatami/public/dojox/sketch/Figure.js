/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.sketch.Figure"]){dojo._hasResource["dojox.sketch.Figure"]=true;dojo.provide("dojox.sketch.Figure");dojo.experimental("dojox.sketch");dojo.require("dojox.gfx");dojo.require("dojox.sketch.UndoStack");(function(){var ta=dojox.sketch;ta.tools={};ta.registerTool=function(_2,fn){ta.tools[_2]=fn;};ta.Figure=function(_4){var _5=this;var _6=1;this.shapes=[];this.image=null;this.imageSrc=null;this.size={w:0,h:0};this.surface=null;this.group=null;this.node=null;this.zoomFactor=1;this.tools=null;this.nextKey=function(){return _6++;};this.obj={};dojo.mixin(this,_4);this.selected=[];this.hasSelections=function(){return this.selected.length>0;};this.isSelected=function(_7){for(var i=0;i<_5.selected.length;i++){if(_5.selected[i]==_7){return true;}}return false;};this.select=function(_9){if(!_5.isSelected(_9)){_5.clearSelections();_5.selected=[_9];}_9.setMode(ta.Annotation.Modes.View);_9.setMode(ta.Annotation.Modes.Edit);};this.deselect=function(_a){var _b=-1;for(var i=0;i<_5.selected.length;i++){if(_5.selected[i]==_a){_b=i;break;}}if(_b>-1){_a.setMode(ta.Annotation.Modes.View);_5.selected.splice(_b,1);}return _a;};this.clearSelections=function(){for(var i=0;i<_5.selected.length;i++){_5.selected[i].setMode(ta.Annotation.Modes.View);}_5.selected=[];};this.replaceSelection=function(n,o){if(!_5.isSelected(o)){_5.select(n);return;}var idx=-1;for(var i=0;i<_5.selected.length;i++){if(_5.selected[i]==o){idx=i;break;}}if(idx>-1){_5.selected.splice(idx,1,n);}};this._c=null;this._ctr=null;this._lp=null;this._action=null;this._prevState=null;this._startPoint=null;this._ctool=null;this._start=null;this._end=null;this._absEnd=null;this._cshape=null;this._dblclick=function(e){var o=_5._fromEvt(e);if(o){_5.onDblClickShape(o,e);}};this._keydown=function(e){var _15=false;if(e.ctrlKey){if(e.keyCode===90){_5.undo();_15=true;}else{if(e.keyCode===89){_5.redo();_15=true;}}}if(e.keyCode===46||e.keyCode===8){_5._delete(_5.selected);_15=true;}if(_15){dojo.stopEvent(e);}};this._md=function(e){var o=_5._fromEvt(e);_5._startPoint={x:e.pageX,y:e.pageY};var win=dijit.getDocumentWindow(_5.node.ownerDocument);_5._ctr=dojo._abs(_5.node);var _19=dojo.withGlobal(win,dojo._docScroll);_5._ctr={x:_5._ctr.x-_19.x,y:_5._ctr.y-_19.y};var X=e.clientX-_5._ctr.x,Y=e.clientY-_5._ctr.y;_5._lp={x:X,y:Y};_5._start={x:X,y:Y};_5._end={x:X,y:Y};_5._absEnd={x:X,y:Y};if(!o){_5.clearSelections();_5._ctool.onMouseDown(e);}else{if(o.type&&o.type()!="Anchor"){if(!_5.isSelected(o)){_5.select(o);_5._sameShapeSelected=false;}else{_5._sameShapeSelected=true;}}o.beginEdit();_5._c=o;}};this._mm=function(e){if(!_5._ctr){return;}var x=e.clientX-_5._ctr.x;var y=e.clientY-_5._ctr.y;var dx=x-_5._lp.x;var dy=y-_5._lp.y;_5._absEnd={x:x,y:y};if(_5._c){_5._c.setBinding({dx:Math.round(dx/_5.zoomFactor),dy:Math.round(dy/_5.zoomFactor)});_5._lp={x:x,y:y};}else{_5._end={x:dx,y:dy};var _21={x:Math.min(_5._start.x,_5._absEnd.x),y:Math.min(_5._start.y,_5._absEnd.y),width:Math.abs(_5._start.x-_5._absEnd.x),height:Math.abs(_5._start.y-_5._absEnd.y)};_5._ctool.onMouseMove(e,_21);}};this._mu=function(e){if(_5._c){_5._c.endEdit();}else{_5._ctool.onMouseUp(e);}_5._c=_5._ctr=_5._lp=_5._action=_5._prevState=_5._startPoint=null;_5._cshape=_5._start=_5._end=_5._absEnd=null;};this._delete=function(arr,_24){for(var i=0;i<arr.length;i++){arr[i].setMode(ta.Annotation.Modes.View);arr[i].destroy(_24);_5.remove(arr[i]);_5._remove(arr[i]);if(!_24){arr[i].onRemove();}}arr.splice(0,arr.length);};this.initUndoStack();};var p=ta.Figure.prototype;p.initUndoStack=function(){this.history=new ta.UndoStack(this);};p.setTool=function(t){this._ctool=t;};p.onDblClickShape=function(_28,e){if(_28["onDblClick"]){_28.onDblClick(e);}};p.onCreateShape=function(_2a){};p.onBeforeCreateShape=function(_2b){};p.initialize=function(_2c){this.node=_2c;this.surface=dojox.gfx.createSurface(_2c,this.size.w,this.size.h);this.surface.createRect({x:0,y:0,width:this.size.w,height:this.size.h}).setFill("white");this.group=this.surface.createGroup();this._cons=[];var es=this.surface.getEventSource();this._cons.push(dojo.connect(es,"ondragstart",dojo.stopEvent),dojo.connect(es,"onselectstart",dojo.stopEvent),dojo.connect(es,"onmousedown",this._md),dojo.connect(es,"onmousemove",this._mm),dojo.connect(es,"onmouseup",this._mu),dojo.connect(es,"onclick",this,"onClick"),dojo.connect(es,"ondblclick",this._dblclick),dojo.connect(es.ownerDocument,"onkeydown",this._keydown));this.group.createRect({x:0,y:0,width:this.size.w,height:this.size.h});this.image=this.group.createImage({width:this.size.w,height:this.size.h,src:this.imageSrc});};p.destroy=function(_2e){if(!this.node){return;}if(!_2e){if(this.history){this.history.destroy();}if(this._subscribed){dojo.unsubscribe(this._subscribed);delete this._subscribed;}}dojo.forEach(this._cons,dojo.disconnect);this._cons=[];this.node.removeChild(this.surface.getEventSource());this.group=this.surface=null;this.obj={};this.shapes=[];};p.draw=function(){};p.zoom=function(pct){this.zoomFactor=pct/100;var w=this.size.w*this.zoomFactor;var h=this.size.h*this.zoomFactor;this.surface.setDimensions(w,h);this.group.setTransform(dojox.gfx.matrix.scale(this.zoomFactor,this.zoomFactor));if(dojo.isIE){this.image.rawNode.style.width=Math.max(w,this.size.w);this.image.rawNode.style.height=Math.max(h,this.size.h);}for(var i=0;i<this.shapes.length;i++){this.shapes[i].zoom(this.zoomFactor);}};p.getFit=function(){var wF=(this.node.parentNode.clientWidth-5)/this.size.w;var hF=(this.node.parentNode.clientHeight-5)/this.size.h;return Math.min(wF,hF)*100;};p.unzoom=function(){this.zoomFactor=1;this.surface.setDimensions(this.size.w,this.size.h);this.group.setTransform();};p._add=function(obj){this.obj[obj._key]=obj;};p._remove=function(obj){if(this.obj[obj._key]){delete this.obj[obj._key];}};p._get=function(key){if(key&&key.indexOf("bounding")>-1){key=key.replace("-boundingBox","");}else{if(key&&key.indexOf("-labelShape")>-1){key=key.replace("-labelShape","");}}return this.obj[key];};p._keyFromEvt=function(e){var key=e.target.id+"";if(key.length==0){var p=e.target.parentNode;var _3b=this.surface.getEventSource();while(p&&p.id.length==0&&p!=_3b){p=p.parentNode;}key=p.id;}return key;};p._fromEvt=function(e){return this._get(this._keyFromEvt(e));};p.add=function(_3d){for(var i=0;i<this.shapes.length;i++){if(this.shapes[i]==_3d){return true;}}this.shapes.push(_3d);return true;};p.remove=function(_3f){var idx=-1;for(var i=0;i<this.shapes.length;i++){if(this.shapes[i]==_3f){idx=i;break;}}if(idx>-1){this.shapes.splice(idx,1);}return _3f;};p.get=function(id){for(var i=0;i<this.shapes.length;i++){if(this.shapes[i].id==id){return this.shapes[i];}}return null;};p.convert=function(ann,t){var _46=t+"Annotation";if(!ta[_46]){return;}var _47=ann.type(),id=ann.id,_49=ann.label,_4a=ann.mode,_4b=ann.tokenId;var _4c,end,_4e,_4f;switch(_47){case "Preexisting":case "Lead":_4f={dx:ann.transform.dx,dy:ann.transform.dy};_4c={x:ann.start.x,y:ann.start.y};end={x:ann.end.x,y:ann.end.y};var cx=end.x-((end.x-_4c.x)/2);var cy=end.y-((end.y-_4c.y)/2);_4e={x:cx,y:cy};break;case "SingleArrow":case "DoubleArrow":_4f={dx:ann.transform.dx,dy:ann.transform.dy};_4c={x:ann.start.x,y:ann.start.y};end={x:ann.end.x,y:ann.end.y};_4e={x:ann.control.x,y:ann.control.y};break;case "Underline":_4f={dx:ann.transform.dx,dy:ann.transform.dy};_4c={x:ann.start.x,y:ann.start.y};_4e={x:_4c.x+50,y:_4c.y+50};end={x:_4c.x+100,y:_4c.y+100};break;case "Brace":}var n=new ta[_46](this,id);if(n.type()=="Underline"){n.transform={dx:_4f.dx+_4c.x,dy:_4f.dy+_4c.y};}else{if(n.transform){n.transform=_4f;}if(n.start){n.start=_4c;}}if(n.end){n.end=end;}if(n.control){n.control=_4e;}n.label=_49;n.token=dojo.lang.shallowCopy(ann.token);n.initialize();this.replaceSelection(n,ann);this._remove(ann);this.remove(ann);ann.destroy();n.setMode(_4a);};p.setValue=function(_53){var obj=dojox.xml.DomParser.parse(_53);var _55=this.node;this.load(obj,_55);this.zoom(this.zoomFactor*100);};p.load=function(obj,n){if(this.surface){this.destroy(true);}var _58=obj.documentElement;this.size={w:parseFloat(_58.getAttribute("width"),10),h:parseFloat(_58.getAttribute("height"),10)};var g=_58.childrenByName("g")[0];var img=g.childrenByName("image")[0];this.imageSrc=img.getAttribute("xlink:href");this.initialize(n);var ann=g.childrenByName("g");for(var i=0;i<ann.length;i++){this._loadAnnotation(ann[i]);}if(this._loadDeferred){this._loadDeferred.callback(this);this._loadDeferred=null;}this.onLoad();};p.onLoad=function(){};p.onClick=function(){};p._loadAnnotation=function(obj){var _5e=obj.getAttribute("dojoxsketch:type")+"Annotation";if(ta[_5e]){var a=new ta[_5e](this,obj.id);a.initialize(obj);this.nextKey();a.setMode(ta.Annotation.Modes.View);this._add(a);return a;}return null;};p.onUndo=function(){};p.onBeforeUndo=function(){};p.onRedo=function(){};p.onBeforeRedo=function(){};p.undo=function(){if(this.history){this.onBeforeUndo();this.history.undo();this.onUndo();}};p.redo=function(){if(this.history){this.onBeforeRedo();this.history.redo();this.onRedo();}};p.serialize=function(){var s="<svg xmlns=\"http://www.w3.org/2000/svg\" "+"xmlns:xlink=\"http://www.w3.org/1999/xlink\" "+"xmlns:dojoxsketch=\"http://dojotoolkit.org/dojox/sketch\" "+"width=\""+this.size.w+"\" height=\""+this.size.h+"\">"+"<g>"+"<image xlink:href=\""+this.imageSrc+"\" x=\"0\" y=\"0\" width=\""+this.size.w+"\" height=\""+this.size.h+"\" />";for(var i=0;i<this.shapes.length;i++){s+=this.shapes[i].serialize();}s+="</g></svg>";return s;};p.getValue=p.serialize;})();}